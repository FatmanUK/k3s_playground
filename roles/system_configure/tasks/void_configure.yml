---
- name: 'Delete unneeded services'
  loop:
    - 'agetty-hvc0'
    - 'agetty-hvsi0'
    - 'agetty-tty4'
    - 'agetty-tty5'
    - 'agetty-tty6'
    - 'agetty-ttyAMA0'
    - 'agetty-ttyUSB0'
    - 'wpa_supplicant'
  file:
    path: '/var/service/{{ item }}'
    state: 'absent'

- name: 'Remove some filesystem paths'
  loop:
    - '/etc/k3s-token'
    - '/etc/k3s-token-file'
    - '/etc/issue.new-0.140_8'
    - '/etc/rc.conf.new-20210314_1'
    - '/etc/cni/net.d'
    - '/etc/myname'
    - '/etc/rancher'
    - '/etc/sudoers.new-1.9.5p2_2'
    - '/usr/libexec/kubernetes'
    - '/usr/lib/virt-sysprep'
    - '/home/ansible/install_k3s.sh'
    - '/home/ansible/k3s'
    - '/var/lib/calico'
    - '/var/lib/rancher'
    - '/var/run/containerd'
  file:
    path: '{{ item }}'
    state: 'absent'

- name: 'Enable sysctl settings'
  loop:
    - 'net.bridge.bridge-nf-call-iptables = 1'
    - 'net.bridge.bridge-nf-call-ip6tables = 1'
    - 'net.ipv4.ip_forward = 1'
  lineinfile:
    path: '/etc/sysctl.conf'
    line: '{{ item }}'
    insertbefore: 'EOF'

- name: 'Create empty iptables settings file'
  copy:
    remote_src: yes
    src: '/etc/iptables/empty.rules'
    dest: '/etc/iptables/iptables.rules'

- name: 'Enable iptables service'
  file:
    state: 'link'
    src: '/etc/sv/iptables'
    dest: '/var/service/iptables'
...
# vim: set filetype=yaml
