---
- name: 'Add gateway'
  lineinfile:
    path: '/etc/sysconfig/network'
    line: 'GATEWAY={{ network_gateway }}'
    insertbefore: 'EOF'

- name: 'Add local repo mount to fstab'
  lineinfile:
    path: '/etc/fstab'
    line: '/dev/sr0  /mnt/disc  iso9660  ro,noauto  0  0'

- name: 'Mount local repo image'
  register: 'reg_mount'
  vars:
    e_notfound: "can't find in /etc/fstab."
    e_already: 'already mounted'
  changed_when:
    - 'reg_mount.rc != 0'
    - 'e_already not in reg_mount.stderr'
  failed_when:
    - 'reg_mount.rc != 0'
    - 'e_notfound in reg_mount.stderr'
  command:
    argv:
      - '/bin/mount'
      - '/mnt/disc'

# TODO: add yum config
# sudo install /mnt/disc/media.repo /etc/yum.repos.d/ -m0644
# change title to AppStream
# add lines:
#enabled=1
#baseurl=file:///mnt/disc/AppStream
#gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release
# Set gpgcheck to 1
# Duplicate and change AppStream to BaseOS wherever you see it
# sudo yum clean all
# sudo yum updates

- name: 'Copy legacy RPMs'
  loop:
    - 'iptables-libs-1.6.2-2.fc28.x86_64.rpm'
    - 'iptables-1.6.2-2.fc28.x86_64.rpm'
  copy:
    src: 'rpms/{{ item }}'
    dest: '/tmp/'

# TODO: failed_when/changed_when
- name: 'Install legacy RPMs'
  register: 'reg_iptables'
  vars:
    legacy_rpms:
      - '/tmp/iptables-libs-1.6.2-2.fc28.x86_64.rpm'
      - '/tmp/iptables-1.6.2-2.fc28.x86_64.rpm'
    command:
      - '/bin/yum'
      - 'localinstall'
      - '--allowerasing'
      - '--nogpgcheck'
      - '-y'
  command:
    argv: '{{ command + legacy_rpms }}'

- name: 'Reboot'
  when: 'reg_iptables is changed'
  reboot:
...
# vim: set filetype=yaml
