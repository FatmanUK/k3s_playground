---
- name: 'Common bootstrapping tasks'
  import_tasks: 'common_install.yml'

- name: 'Copy server token'
  register: 'reg_token'
  delegate_to: 'k3s-mother-001'
  run_once: yes
  slurp:
    src: '{{ k3s_token_file }}'

- name: 'Install for RHEL'
  when: 'distro == "rhel"'
  import_tasks: 'rhel_install.yml'

- name: 'Install for Void'
  when: 'distro == "void"'
  import_tasks: 'void_install.yml'

- name: 'Reboot'
  reboot:

# TODO: see what effect async and poll have on this task, maybe use it more
# TODO: figure out failed_when condition for kubectl wait
- name: 'Wait for all nodes to exist'
  register: 'reg_nodes'
  retries: 60
  delay: 10
  until: 'reg_nodes is success'
  delegate_to: '{{ groups.k3s_primary_masters | first }}'
  command:
    argv:
      - '{{ k3s_binary_dir }}/kubectl'
      - 'get'
      - 'node'
      - '{{ fqdn }}'

#cat | sudo tee /etc/rancher/k3s/registries.yaml <<EOF
## BEGIN ANSIBLE MANAGED BLOCK --- registry
#mirrors:
#  docker.io:
#    endpoint:
#      - 'http://127.0.0.1:30555'
## END ANSIBLE MANAGED BLOCK --- registry
#EOF
...
# vim: set filetype=yaml
