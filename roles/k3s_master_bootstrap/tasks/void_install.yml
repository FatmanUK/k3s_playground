---
- name: 'Check directory exists'
  register: 'reg_stat'
  stat:
    path: '{{ k3s_service_dir }}'

- name: 'Prevent service start'
  when: 'reg_stat.stat.exists'
  register: 'reg_prevent_start'
  vars:
    e_fail: 'could not touch target'
  failed_when:
    - 'reg_prevent_start is failed'
    - 'e_fail not in reg_prevent_start.msg'
  file:
    state: 'touch'
    path: '{{ k3s_down_file }}'
    owner: 'root'
    group: 'root'
    mode: '0444'

- name: 'Stop service'
  when: 'reg_stat.stat.exists'
  failed_when: no
  #runit:
  #  name: 'k3s'
  #  state: 'stopped'
  command:
    argv:
      - '/usr/bin/sv'
      - 'down'
      - 'k3s'

- name: 'Uninstall service'
  file:
    path: '{{ k3s_service_dir }}'
    state: 'absent'

- name: 'Create service directories'
  loop:
    - '{{ k3s_service_dir }}/log'
  file:
    path: '{{ item }}'
    state: 'directory'

- name: 'Template in runit service'
  vars:
    log_file: '/var/log/k3s'
  loop: '{{ k3s_service_files }}'
  template:
    src: '{{ item.file[1:] }}.j2'
    dest: '{{ item.file }}'
    mode: '{{ item.mode | default("0644") }}'

- name: 'Enable service'
  file:
    state: 'link'
    src: '{{ k3s_service_dir }}'
    dest: '/var/service/k3s'
...
# vim: set filetype=yaml
