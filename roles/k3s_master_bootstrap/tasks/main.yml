---
- name: 'Common bootstrapping tasks'
  import_tasks: 'common_install.yml'

# Not sure I can add this to the meta hosts role as it is.
#- name: 'Add k3s-vip to hosts file'
#  vars:
#    vip_name: 'k3s-vip'
#  lineinfile:
#    path: '/etc/hosts'
#    line: '{{ k3s_vip_hosts_line }}'

- name: 'Template in some files'
  loop: '{{ bootstrap_templates }}'
  template:
    src: '{{ item[1:] }}.j2'
    dest: '{{ item }}'

- name: 'Copy token file from primary'
  when: 'is_primary'
  register: 'reg_read_token'
  run_once: yes
  slurp:
    path: '{{ k3s_token_file }}'

- name: 'Set server_token fact'
  set_fact:
    server_token: '{{ (reg_read_token.content | b64decode).split("\n")[0] }}'

- name: 'Install for RHEL'
  when: 'distro == "rhel"'
  import_tasks: 'rhel_install.yml'

- name: 'Install for Void'
  when: 'distro == "void"'
  import_tasks: 'void_install.yml'

- name: 'Reboot primary'
  when: 'is_primary'
  reboot:
    post_reboot_delay: 30

- name: 'Reboot secondaries'
  when: 'not is_primary'
  reboot:
    post_reboot_delay: 10

# TODO: see what effect async and poll have on this task, maybe use it more
# TODO: figure out failed_when condition for kubectl wait
# Nodes won't go to Ready state without a CNI installed, but we can check they exist. Didn't know that was necessary.
- name: 'Wait for all nodes to exist'
  retries: 60
  delay: 10
  command:
    argv:
      - '{{ k3s_binary_dir }}/kubectl'
      - 'get'
      - 'node'
      - '{{ inventory_hostname }}.{{ domain }}'

# TODO: failed_when
# fatal: [k3s-mother-001]: FAILED! => {"changed": true, "cmd": ["/usr/local/bin/kubectl", "create", "namespace", "emissary"], "delta": "0:00:00.095668", "end": "2024-02-25 10:35:16.207686", "msg": "non-zero return code", "rc": 1, "start": "2024-02-25 10:35:16.112018", "stderr": "Error from server (AlreadyExists): namespaces \"emissary\" already exists", "stderr_lines": ["Error from server (AlreadyExists): namespaces \"emissary\" already exists"], "stdout": "", "stdout_lines": []}
- name: 'Create emissary namespace'
  run_once: yes
  command: '{{ k3s_binary_dir }}/kubectl create namespace emissary'
...
# vim: set filetype=yaml
