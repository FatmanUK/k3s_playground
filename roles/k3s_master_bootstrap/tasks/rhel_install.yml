---
- name: 'Stop and disable service'
  failed_when: no
  systemd:
    name: 'k3s'
    enabled: no
    state: 'stopped'
    daemon_reload: yes

- name: 'Install service'
  vars:
    k3s_options: "{{ (opts_common + ([] if is_primary else opts_secondary)) | join(' ') }}"
  loop:
    - '/etc/systemd/system/k3s.service'
  template:
    src: '{{ item[1:] }}.j2'
    dest: '{{ item }}'

# TODO: failed_when
- name: 'Reset SELinux context on service file'
  loop:
    - '/etc/systemd/system/k3s.service'
    - '/etc/rancher/k3s/k3s.env'
  command:
    argv:
      - 'restorecon'
      - '-R'
      - '-i'
      - '{{ item }}'

- name: 'Start service'
  systemd:
    name: 'k3s'
    enabled: yes
...
# vim: set filetype=yaml
